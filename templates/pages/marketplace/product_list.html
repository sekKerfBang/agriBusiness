{% extends 'base.html' %}
{% load static %}

{% block title %}Nos Produits Frais - AgriBusiness Marketplace{% endblock %}

{% block extra_css %}
<style>
  /* En-tête */
  .page-header {
    text-align: center;
    padding: 4rem 0 3rem;
    background: linear-gradient(rgba(46, 125, 50, 0.05), transparent);
  }

  .page-title {
    font-size: 3rem;
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 1rem;
  }

  .page-subtitle {
    font-size: 1.3rem;
    color: #4caf50;
    font-weight: 500;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Filtres */
  .filters-bar {
    background: white;
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 2.5rem;
    box-shadow: 0 6px 20px rgba(0,0,0,0.06);
  }

  .filters-form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: end;
  }

  .filter-group {
    flex: 1;
    min-width: 200px;
  }

  .filter-label {
    font-weight: 600;
    color: #2e7d32;
    margin-bottom: 0.5rem;
    display: block;
  }

  .results-count {
    color: #4caf50;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  /* Grille produits (inchangée, excellente) */
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2.5rem;
    padding: 2rem 0;
  }

  @media (max-width: 768px) {
    .filters-form {
      flex-direction: column;
    }
    .filter-group {
      min-width: 100%;
    }
    .page-title {
      font-size: 2.5rem;
    }
  }

  @media (max-width: 576px) {
    .products-grid {
      grid-template-columns: 1fr;
      gap: 2rem;
      padding: 1rem;
    }
  }

  /* Pagination améliorée */
  .custom-pagination {
    margin: 4rem 0;
  }

  .pagination {
    justify-content: center;
    gap: 0.5rem;
  }

  .page-item .page-link {
    border-radius: 12px !important;
    padding: 0.8rem 1.4rem;
    font-weight: 600;
    color: #2e7d32;
    border: 2px solid #4caf50;
    background: white;
    transition: all 0.3s ease;
  }

  .page-item.active .page-link {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    border-color: #4caf50;
  }

  .page-item .page-link:hover:not(.active) {
    background: #e8f5e9;
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(76, 175, 80, 0.2);
  }

  .page-item.disabled .page-link {
    color: #aaa;
    border-color: #ddd;
  }

  .page-item .page-link.dots {
    background: transparent;
    border: none;
    color: #4caf50;
    font-weight: bold;
  }

  /* Carte produit */
  .product-card {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .product-card:hover {
    transform: translateY(-15px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
  }

  .product-image-wrapper {
    position: relative;
    height: 240px;
    overflow: hidden;
    background: #f8f9fa;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s ease;
  }

  .product-card:hover .product-image {
    transform: scale(1.12);
  }

  /* Image par défaut stylisée */
  .no-image {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    color: #4caf50;
  }

  .no-image i {
    font-size: 4.5rem;
    opacity: 0.6;
  }

  /* Corps de la carte */
  .product-body {
    padding: 1.8rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .product-name {
    font-size: 1.35rem;
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 0.8rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .producer-link {
    color: #66bb6a;
    font-weight: 500;
    text-decoration: none;
    font-size: 1.05rem;
    margin-bottom: 1rem;
    display: inline-block;
  }

  .producer-link:hover {
    color: #388e3c;
    text-decoration: underline;
  }

  .price-stock {
    margin-top: auto;
    padding-top: 1rem;
  }

  .product-price {
    font-size: 2rem;
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 0.5rem;
  }

  .stock-info {
    font-size: 0.95rem;
    font-weight: 500;
    margin-bottom: 1rem;
  }

  .stock-low {
    color: #ef6c00;
  }

  .stock-good {
    color: #4caf50;
  }

  .stock-out {
    color: #d32f2f;
    font-weight: 600;
  }

  /* Bouton ajouter au panier */
  .btn-add-cart {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    border: none;
    border-radius: 14px;
    padding: 0.9rem 1.8rem;
    font-weight: 600;
    font-size: 1.05rem;
    width: 100%;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
  }

  .btn-add-cart:hover:not(:disabled) {
    background: linear-gradient(135deg, #388e3c, #2e7d32);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
  }

  .btn-add-cart:disabled {
    background: #cccccc;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Message vide */
  .empty-message {
    grid-column: 1 / -1;
    text-align: center;
    padding: 5rem 2rem;
    color: #666;
  }

  .empty-message i {
    font-size: 5rem;
    color: #c8e6c9;
    margin-bottom: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <h1 class="page-title">Nos Produits Frais</h1>
    <p class="page-subtitle">Directement des producteurs aux consommateurs – qualité garantie</p>
  </div>
</div>

<div class="container">
  <!-- Résultats et filtres -->
  <div class="filters-bar">
    <p class="results-count">
      {{ total_products }} produit{{ total_products|pluralize }} trouvé{{ total_products|pluralize }}
    </p>

    <form method="get" class="filters-form">
      <!-- Recherche -->
      <div class="filter-group">
        <label class="filter-label">Rechercher</label>
        <input type="text" name="search" value="{{ current_search }}" placeholder="Tomates, pommes..." class="form-control">
      </div>

      <!-- Catégorie -->
      <div class="filter-group">
        <label class="filter-label">Catégorie</label>
        <select name="category" class="form-control">
          <option value="">Toutes les catégories</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}" {% if current_category == cat.id|stringformat:"s" %}selected{% endif %}>
              {{ cat.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Tri -->
      <div class="filter-group">
        <label class="filter-label">Trier par</label>
        <select name="sort" class="form-control">
          <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Plus récents</option>
          <option value="price" {% if current_sort == 'price' %}selected{% endif %}>Prix croissant</option>
          <option value="-price" {% if current_sort == '-price' %}selected{% endif %}>Prix décroissant</option>
          <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Nom A → Z</option>
          <option value="-name" {% if current_sort == '-name' %}selected{% endif %}>Nom Z → A</option>
        </select>
      </div>

      <div class="filter-group">
        <button type="submit" class="btn btn-success px-5">
          <i class="fas fa-search me-2"></i> Filtrer
        </button>
      </div>
    </form>
  </div>

  <!-- Liste des produits -->
  {% if products %}
    <div class="products-grid">
      {% for product in products %}
        <div class="product-card">
          <div class="product-image-wrapper">
            {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
            {% else %}
              <div class="no-image d-flex align-items-center justify-content-center">
                <i class="fas fa-seedling"></i>
              </div>
            {% endif %}
          </div>

          <div class="product-body">
            <h3 class="product-name">{{ product.name }}</h3>
            
            <a href="{% url 'marketplace:producer_detail' product.producer.id %}" class="producer-link">
              <i class="fas fa-user me-1"></i> {{ product.producer.user.get_full_name|default:product.producer.user.username }}
            </a>

            <div class="price-stock">
              <div class="product-price">{{ product.price|floatformat:2 }} €</div>
              
              <div class="stock-info {% if product.stock == 0 %}stock-out{% elif product.stock < 10 %}stock-low{% else %}stock-good{% endif %}">
                {% if product.stock == 0 %}
                  <i class="fas fa-times-circle me-1"></i> Rupture de stock
                {% elif product.stock < 10 %}
                  <i class="fas fa-exclamation-triangle me-1"></i> Stock faible : {{ product.stock }} restant(s)
                {% else %}
                  <i class="fas fa-check-circle me-1"></i> {{ product.stock }} en stock
                {% endif %}
              </div>
            </div>

            {% if product.stock > 0 %}
              <button class="btn btn-add-cart btn-lg mt-3"
                      hx-post="{% url 'marketplace:add_to_cart' product.id %}"
                      hx-include="#csrf-token"
                      hx-target="#cart-count"
                      hx-swap="innerHTML"
                      hx-on::after-request="
                        this.innerHTML = '<i class='fas fa-check me-2'></i>Ajouté !';
                        this.disabled = true;
                        setTimeout(() => {
                          this.innerHTML = '<i class='fas fa-cart-plus me-2'></i>Ajouter au panier';
                          this.disabled = false;
                        }, 2000);
                      ">
                <i class="fas fa-cart-plus me-2"></i>Ajouter au panier
              </button>
            {% else %}
              <button class="btn btn-add-cart mt-3" disabled>
                <i class="fas fa-ban me-2"></i>Indisponible
              </button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination avec filtres conservés -->
    {% if is_paginated %}
      <nav aria-label="Pagination" class="custom-pagination">
        <ul class="pagination">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{{ current_query.urlencode }}&page={{ page_obj.previous_page_number }}">Précédent</a>
            </li>
          {% endif %}

          {% for num in page_obj.paginator.get_elided_page_range %}
            {% if num == page_obj.paginator.ELLIPSIS %}
              <li class="page-item disabled">
                <span class="page-link dots">...</span>
              </li>
            {% else %}
              <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?{{ current_query.urlencode }}&page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{{ current_query.urlencode }}&page={{ page_obj.next_page_number }}">Suivant</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <div class="text-center py-5 my-5">
      <i class="fas fa-search" style="font-size: 5rem; color: #c8e6c9; margin-bottom: 2rem;"></i>
      <h3 class="text-muted">Aucun produit correspondant à votre recherche</h3>
      <p class="text-muted lead">Essayez avec d'autres termes ou explorez toutes nos catégories.</p>
      <a href="{% url 'marketplace:product_list' %}" class="btn btn-success btn-lg rounded-pill px-5 mt-3">
        Voir tous les produits
      </a>
    </div>
  {% endif %}
</div>
{% endblock %}



{% comment %} {% extends 'base.html' %}
{% load static %}

{% block title %}Nos Produits Frais - AgriBusiness Marketplace{% endblock %}

{% block extra_css %}
<style>
  /* Titre principal */
  .page-header {
    text-align: center;
    padding: 4rem 0 3rem;
    background: linear-gradient(rgba(46, 125, 50, 0.05), transparent);
  }

  .page-title {
    font-size: 3rem;
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 1rem;
    text-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .page-subtitle {
    font-size: 1.3rem;
    color: #4caf50;
    font-weight: 500;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Grille de produits responsive */
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2.5rem;
    padding: 2rem 0;
  }

  @media (max-width: 576px) {
    .products-grid {
      grid-template-columns: 1fr;
      gap: 2rem;
      padding: 1rem;
    }
    .page-title {
      font-size: 2.4rem;
    }
  }

  /* Carte produit */
  .product-card {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .product-card:hover {
    transform: translateY(-15px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
  }

  .product-image-wrapper {
    position: relative;
    height: 240px;
    overflow: hidden;
    background: #f8f9fa;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s ease;
  }

  .product-card:hover .product-image {
    transform: scale(1.12);
  }

  /* Image par défaut stylisée */
  .no-image {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    color: #4caf50;
  }

  .no-image i {
    font-size: 4.5rem;
    opacity: 0.6;
  }

  /* Corps de la carte */
  .product-body {
    padding: 1.8rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .product-name {
    font-size: 1.35rem;
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 0.8rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .producer-link {
    color: #66bb6a;
    font-weight: 500;
    text-decoration: none;
    font-size: 1.05rem;
    margin-bottom: 1rem;
    display: inline-block;
  }

  .producer-link:hover {
    color: #388e3c;
    text-decoration: underline;
  }

  .price-stock {
    margin-top: auto;
    padding-top: 1rem;
  }

  .product-price {
    font-size: 2rem;
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 0.5rem;
  }

  .stock-info {
    font-size: 0.95rem;
    font-weight: 500;
    margin-bottom: 1rem;
  }

  .stock-low {
    color: #ef6c00;
  }

  .stock-good {
    color: #4caf50;
  }

  .stock-out {
    color: #d32f2f;
    font-weight: 600;
  }

  /* Bouton ajouter au panier */
  .btn-add-cart {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    border: none;
    border-radius: 14px;
    padding: 0.9rem 1.8rem;
    font-weight: 600;
    font-size: 1.05rem;
    width: 100%;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
  }

  .btn-add-cart:hover:not(:disabled) {
    background: linear-gradient(135deg, #388e3c, #2e7d32);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
  }

  .btn-add-cart:disabled {
    background: #cccccc;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Message vide */
  .empty-message {
    grid-column: 1 / -1;
    text-align: center;
    padding: 5rem 2rem;
    color: #666;
  }

  .empty-message i {
    font-size: 5rem;
    color: #c8e6c9;
    margin-bottom: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <h1 class="page-title">Nos Produits Frais</h1>
    <p class="page-subtitle">Directement des producteurs aux consommateurs – qualité garantie</p>
  </div>
</div>

<div class="container">
  <div class="products-grid">
    {% for product in products %}
      <div class="product-card">
        <div class="product-image-wrapper">
          {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
          {% else %}
            <div class="no-image d-flex align-items-center justify-content-center">
              <i class="fas fa-seedling"></i>
            </div>
          {% endif %}
        </div>

        <div class="product-body">
          <h3 class="product-name">{{ product.name }}</h3>
          
          <a href="{% url 'marketplace:producer_detail' product.producer.id %}" class="producer-link">
            <i class="fas fa-user mr-1"></i> {{ product.producer.user.username }}
          </a>

          <div class="price-stock">
            <div class="product-price">{{ product.price|floatformat:2 }} €</div>
            
            <div class="stock-info {% if product.stock == 0 %}stock-out{% elif product.stock < 10 %}stock-low{% else %}stock-good{% endif %}">
              {% if product.stock == 0 %}
                <i class="fas fa-times-circle mr-1"></i> Rupture de stock
              {% elif product.stock < 10 %}
                <i class="fas fa-exclamation-triangle mr-1"></i> Stock faible : {{ product.stock }} restant(s)
              {% else %}
                <i class="fas fa-check-circle mr-1"></i> {{ product.stock }} en stock
              {% endif %}
            </div>
          </div>

          {% if product.stock > 0 %}
            <button class="btn btn-add-cart btn-lg mt-3"
                    hx-post="{% url 'marketplace:add_to_cart' product.id %}"
                    hx-include="#csrf-token"
                    hx-target="#cart-count"
                    hx-swap="innerHTML"
                    hx-on::after-request="
                      this.innerHTML = '<i class=\'fas fa-check mr-2\'></i>Ajouté !';
                      this.disabled = true;
                      setTimeout(() => {
                        this.innerHTML = '<i class=\'fas fa-cart-plus mr-2\'></i>Ajouter au panier';
                        this.disabled = false;
                      }, 2000);
                    "                   
                    >
              <i class="fas fa-cart-plus mr-2"></i>Ajouter au panier
            </button>
          {% else %}
            <button class="btn btn-add-cart mt-3" disabled>
              <i class="fas fa-ban mr-2"></i>Indisponible
            </button>
          {% endif %}
        </div>
      </div>

    {% empty %}
      <div class="empty-message">
        <i class="fas fa-leaf"></i>
        <h3>Aucun produit disponible pour le moment</h3>
        <p>Revenez bientôt, nos producteurs ajoutent régulièrement de nouveaux produits frais !</p>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %} {% endcomment %}
