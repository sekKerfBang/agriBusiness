{% load static %}

<div id="cart-items">
  {% for item in cart.items.all %}
    <div class="cart-item" id="cart-item-{{ item.id }}">
      <!-- Image -->
      <div class="cart-item-image">
        {% if item.product.image %}
          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
        {% else %}
          <div class="no-image d-flex align-items-center justify-content-center">
            <i class="fas fa-seedling"></i>
          </div>
        {% endif %}
      </div>

      <!-- Détails -->
      <div class="cart-item-details">
        <h4 class="cart-item-name">{{ item.product.name }}</h4>
        <p class="cart-item-producer">
          <i class="fas fa-user mr-1"></i> Par {{ item.product.producer.user.username }}
        </p>

        <div class="d-flex flex-wrap justify-content-between align-items-end mt-3">
          <div>
            <div class="cart-item-price">{{ item.product.price|floatformat:2 }} € / unité</div>
            <div class="cart-item-subtotal mt-1">Sous-total : €{{ item.get_subtotal|floatformat:2 }}</div>
          </div>

          <!-- Contrôles quantité -->
          <div class="quantity-controls">
            <button class="quantity-btn"
                    hx-post="{% url 'marketplace:update_cart_quantity' item.id %}"
                    hx-vals='{"quantity_change": -1}'
                    hx-target="#cart-items"
                    hx-swap="innerHTML"
                    {% if item.quantity <= 1 %}disabled{% endif %}>
              <i class="fas fa-minus"></i>
            </button>

            <span class="quantity-display">{{ item.quantity }}</span>

            <button class="quantity-btn"
                    hx-post="{% url 'marketplace:update_cart_quantity' item.id %}"
                    hx-vals='{"quantity_change": 1}'
                    hx-target="#cart-items"
                    hx-swap="innerHTML">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Suppression avec Toggle -->
      <div>
        <!-- Bouton Supprimer (affiché par défaut) -->
        <button id="delete-btn-{{ item.id }}" 
                class="btn btn-outline-danger btn-sm rounded-pill px-4"
                hx-on:click="
                  document.getElementById('confirm-btn-{{ item.id }}').style.display = 'inline-block';
                  this.style.display = 'none';
                ">
          <i class="fas fa-trash-alt mr-1"></i> Supprimer
        </button>
        
        <!-- Bouton Confirmer (caché par défaut) -->
        <button id="confirm-btn-{{ item.id }}" 
                style="display: none;"
                hx-delete="{% url 'marketplace:remove_from_cart' item.id %}"
                hx-target="#cart-items"
                hx-swap="innerHTML"
                class="btn btn-danger btn-sm rounded-pill px-4"
                hx-on:click="this.style.display='none';">
          <i class="fas fa-exclamation-triangle mr-1"></i> Confirmer ?
        </button>
      </div>
    </div>
  {% endfor %}

  {% if not cart.items.exists %}
    <div class="text-center py-5">
      <i class="fas fa-shopping-cart" style="font-size: 4rem; color: var(--light-sage);"></i>
      <p class="mt-3 text-muted">Votre panier est vide</p>
    </div>
  {% endif %}
</div>
{% block extra_js %}
<script>
  document.addEventListener('click', function(e) {
    // Si on clique en dehors d'un bouton de suppression
    if (!e.target.closest('.cart-item')) {
      document.querySelectorAll('#confirm-btn-{{ item.id }}').forEach(btn => {
        btn.style.display = 'none';
      });
      document.querySelectorAll('#delete-btn-{{ item.id }}').forEach(btn => {
        btn.style.display = 'inline-block';
      });
    }
  });
</script>
{% endblock %}


{% comment %} {% load static %}

<div id="cart-items">
  {% for item in cart.items.all %}
    <div class="cart-item" id="cart-item-{{ item.id }}">
      <!-- Image -->
      <div class="cart-item-image">
        {% if item.product.image %}
          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
        {% else %}
          <div class="no-image d-flex align-items-center justify-content-center">
            <i class="fas fa-seedling"></i>
          </div>
        {% endif %}
      </div>

      <!-- Détails -->
      <div class="cart-item-details">
        <h4 class="cart-item-name">{{ item.product.name }}</h4>
        <p class="cart-item-producer">
          <i class="fas fa-user mr-1"></i> Par {{ item.product.producer.user.username }}
        </p>

        <div class="d-flex flex-wrap justify-content-between align-items-end mt-3">
          <div>
            <div class="cart-item-price">{{ item.product.price|floatformat:2 }} € / unité</div>
            <div class="cart-item-subtotal mt-1">Sous-total : €{{ item.get_subtotal|floatformat:2 }}</div>
          </div>

          <!-- Contrôles quantité -->
          <div class="quantity-controls">
            <button class="quantity-btn"
                    hx-post="{% url 'marketplace:update_cart_quantity' item.id %}"
                    hx-vals='{"quantity_change": -1}'
                    hx-target="#cart-items"
                    hx-swap="innerHTML"
                    {% if item.quantity <= 1 %}disabled{% endif %}>
              <i class="fas fa-minus"></i>
            </button>

            <span class="quantity-display">{{ item.quantity }}</span>

            <button class="quantity-btn"
                    hx-post="{% url 'marketplace:update_cart_quantity' item.id %}"
                    hx-vals='{"quantity_change": 1}'
                    hx-target="#cart-items"
                    hx-swap="innerHTML">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Suppression -->
      <div>
        <button class="btn btn-outline-danger btn-sm rounded-pill px-4"
                hx-delete="{% url 'marketplace:remove_from_cart' item.id %}"
                hx-target="#cart-items"
                hx-swap="innerHTML"
                hx-confirm="Supprimer cet article du panier ?">
          <i class="fas fa-trash-alt mr-1"></i> 
        </button>
      </div>
    </div>
  {% endfor %}

  {% if not cart.items.exists %}
    <div class="text-center py-5">
      <i class="fas fa-shopping-cart" style="font-size: 4rem; color: #c8e6c9;"></i>
      <p class="mt-3 text-muted">Votre panier est vide</p>
    </div>
  {% endif %}
</div> {% endcomment %}