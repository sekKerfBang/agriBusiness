{% extends 'base.html' %}
{% load static %}{% block title %}Paiement Sécurisé - AgriBusiness{% endblock %}{% block extra_css %}<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
  /* En-tête principal */
  .checkout-header {
    text-align: center;
    padding: clamp(3rem, 8vw, 4rem) clamp(1.5rem, 5vw, 2rem) clamp(2.5rem, 6vw, 3rem);
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.08), rgba(46, 125, 50, 0.03));
    border-radius: 30px;
    margin-bottom: 3rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  }

  .checkout-title {
    font-size: clamp(2.2rem, 5vw, 3rem);
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 1rem;
  }  .checkout-subtitle {
    font-size: clamp(0.8rem, 2.5vw, 1rem);
    color: #4caf50;
    font-weight: 500;
    max-width: 700px;
    margin: 0 auto;
  }  .security-badges {
    margin-top: 2rem;
    opacity: 0.85;
    display: flex;
    justify-content: center;
    gap: clamp(1rem, 3vw, 1.5rem);
  }  .security-badges i {
    font-size: clamp(2rem, 5vw, 2.8rem);
    color: #4caf50;
  }  /* Cartes */
  .checkout-card {
    background: white;
    border-radius: 28px;
    padding: clamp(2rem, 5vw, 3rem);
    box-shadow: 0 12px 40px rgba(0,0,0,0.09);
  }  .section-title {
    font-size: clamp(1.6rem, 4vw, 2rem);
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 2rem;
    padding-bottom: 0.8rem;
    border-bottom: 4px solid #4caf50;
    display: inline-block;
  }  /* Formulaire */
  .form-label {
    font-weight: 600;
    color: #2e7d32;
    margin-bottom: 0.8rem;
    font-size: clamp(0.95rem, 2.5vw, 1.05rem);
  }  .form-control {
    border-radius: 14px;
    border: 2px solid #e0e0e0;
    padding: clamp(0.8rem, 2vw, 1rem) clamp(1.2rem, 3vw, 1.4rem);
    font-size: clamp(0.95rem, 2.5vw, 1.05rem);
    transition: all 0.3s ease;
    background: #f8fff8;
  }  .form-control:focus {
    border-color: #4caf50;
    box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.2);
    background: white;
  }  textarea.form-control {
    min-height: clamp(100px, 25vw, 130px);
    resize: vertical;
  }  /* Stripe Element */
  #payment-element {
    background: white;
    padding: clamp(1.2rem, 4vw, 1.8rem);
    border-radius: 16px;
    border: 2px solid #e0e0e0;
    min-height: 120px;
    margin: 2rem 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }  /* Messages */
  #payment-message {
    min-height: 1.5em;
    padding: 0.8rem 0;
    font-size: clamp(0.85rem, 2.5vw, 1rem);
  }  /* Bouton paiement */
  .btn-pay {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    font-weight: 800;
    font-size: clamp(1.2rem, 3vw, 1.4rem);
    padding: clamp(1rem, 3vw, 1.3rem) clamp(2rem, 5vw, 2.5rem);
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    transition: all 0.3s ease;
    width: 100%;
    border: none;
  }  .btn-pay:hover:not(:disabled) {
    transform: translateY(-6px);
    box-shadow: 0 20px 40px rgba(76, 175, 80, 0.5);
  }  .btn-pay:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }  /* Récapitulatif */
  .order-summary {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    border-radius: 28px;
    padding: clamp(2.5rem, 5vw, 3rem);
    box-shadow: 0 15px 45px rgba(76, 175, 80, 0.35);
    position: sticky;
    top: 120px;
    height: fit-content;
  }  .summary-title {
    font-size: clamp(1.5rem, 3.5vw, 2rem);
    font-weight: 700;
    margin-bottom: 2rem;
    text-align: center;
  }  .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px dashed rgba(255,255,255,0.4);
    font-size: clamp(1rem, 2.5vw, 1.1rem);
  }  .summary-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }  .summary-total {
    font-size: clamp(1.8rem, 4vw, 2rem);
    font-weight: 900;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 3px solid white;
  }  /* Responsive */
  @media
 (max-width: 992px) {
    .order-summary {
      position: static;
      margin-top: 3rem;
    }
    .checkout-title {
      font-size: 2.6rem;
    }
  }  @media
 (max-width: 576px) {
    .checkout-header {
      padding: 3rem 1rem;
    }
    .checkout-card {
      padding: 2rem;
    }
    .section-title {
      font-size: 1.8rem;
    }
    .btn-pay {
      font-size: 1.2rem;
      padding: 1.1rem;
    }
  }
</style>
{% endblock %}{% block content %}<div class="container my-5" data-aos="fade-up">
  <!-- En-tête -->
  <div class="checkout-header" data-aos="zoom-in" data-aos-delay="100">
    <h1 class="checkout-title">Finaliser votre commande</h1>
    <p class="checkout-subtitle">
      Paiement 100% sécurisé • Livraison rapide par nos producteurs locaux
    </p>
    <div class="security-badges">
      <i class="fas fa-lock" title="Paiement chiffré"></i>
      <i class="fas fa-shield-alt" title="Données protégées"></i>
      <i class="fas fa-truck" title="Livraison traçable"></i>
    </div>
  </div>

  <div class="row g-5">
    <!-- Formulaire adresse + paiement -->
    <div class="col-lg-8">
      <div class="checkout-card" data-aos="fade-right" data-aos-delay="200">
        <form method="post" id="payment-form">
          {% csrf_token %}

      <!-- Adresse de livraison -->
      <h3 class="section-title">
        <i class="fas fa-home me-3"></i>Adresse de livraison
      </h3>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nom complet *</label>
          {{ form.full_name }}
          {% if form.full_name.errors %}
            <div class="text-danger small mt-1">{{ form.full_name.errors }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Téléphone *</label>
          {{ form.phone }}
          {% if form.phone.errors %}
            <div class="text-danger small mt-1">{{ form.phone.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-4">
        <label class="form-label">Adresse ligne 1 *</label>
        {{ form.address_line_1 }}
        {% if form.address_line_1.errors %}
          <div class="text-danger small mt-1">{{ form.address_line_1.errors }}</div>
        {% endif %}
      </div>

      <div class="mt-4">
        <label class="form-label">Complément d'adresse (appartement, étage...)</label>
        {{ form.address_line_2 }}
      </div>

      <div class="row g-3 mt-4">
        <div class="col-md-4">
          <label class="form-label">Ville *</label>
          {{ form.city }}
          {% if form.city.errors %}
            <div class="text-danger small mt-1">{{ form.city.errors }}</div>
          {% endif %}
        </div>
        <div class="col-md-4">
          <label class="form-label">Code postal *</label>
          {{ form.postal_code }}
          {% if form.postal_code.errors %}
            <div class="text-danger small mt-1">{{ form.postal_code.errors }}</div>
          {% endif %}
        </div>
        {% comment %} <div class="col-md-4">
          <label class="form-label">Pays *</label>
          {{ form.country }}  <!-- Ajout du champ pays, assume ajouté au form -->
          {% if form.country.errors %}
            <div class="text-danger small mt-1">{{ form.country.errors }}</div>
          {% endif %}
        </div> {% endcomment %}
      </div>

      <div class="mt-5">
        <label class="form-label">Notes pour le producteur (facultatif)</label>
        {{ form.notes }}
        <small class="text-muted d-block mt-2">
          Ex: "Laisser devant la porte", "Appeler avant livraison", "Accès par le petit portail vert", "Remettre au voisin si absent", etc.
        </small>
      </div>

      <!-- Paiement -->
      <h3 class="section-title mt-5">
        <i class="fas fa-credit-card me-3"></i>Paiement sécurisé par carte
      </h3>

      <div id="payment-element">
        <!-- Stripe injectera le formulaire ici -->
      </div>

      <div id="payment-message" class="fw-bold"></div>

      <button type="submit" class="btn btn-pay mt-4" id="submit-btn">
        <span class="btn-text">
          <i class="fas fa-lock me-3"></i>
          Payer {{ cart.get_total_amount|floatformat:2 }} GNF
        </span>
        <span class="btn-loading" style="display:none;">
          <i class="fas fa-spinner fa-spin me-3"></i> Traitement en cours...
        </span>
      </button>
    </form>
  </div>
</div>

<!-- Récapitulatif commande -->
<div class="col-lg-4">
  <div class="order-summary" id="order-summary" data-aos="fade-left" data-aos-delay="300">
    <h3 class="summary-title">
      <i class="fas fa-receipt me-3"></i>Récapitulatif
    </h3>

    {% for item in cart.items.all %}
      <div class="summary-item">
        <span>{{ item.quantity }} * {{ item.product.name }}</span>
        <strong>{{ item.get_subtotal|floatformat:2 }} GNF </strong>
      </div>
    {% endfor %}

    <div class="summary-item summary-total d-flex justify-content-between">
      <span>Total à payer</span>
      <span>{{ cart.get_total_amount|floatformat:2 }} GNF </span>
    </div>
  </div>
</div>  </div>
</div>

<!-- Stripe + Gestion paiement -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  {% if client_secret %}
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements({
      clientSecret: '{{ client_secret }}'
    });
    const paymentElement = elements.create('payment', {
      layout: 'tabs'
    });
    paymentElement.mount('#payment-element');

    const form = document.getElementById('payment-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const messageDiv = document.getElementById('payment-message');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline-block';
      messageDiv.textContent = '';

      // Collecter données du formulaire
      const formData = new FormData(form);
      const address = Object.fromEntries(formData);  // {full_name: ..., etc.}

      try {
        // Envoyer les données d'adresse au serveur via fetch (AJAX)
        const response = await fetch("{% url 'marketplace:store_checkout_data' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify(address)
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Erreur lors du stockage des données');
        }

        // Si OK, confirmer le paiement avec Stripe
        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: window.location.origin + "{% url 'marketplace:payment_success' %}",
            payment_method_data: {
              billing_details: {
                name: address.full_name,
                phone: address.phone,
                address: {
                  line1: address.address_line_1,
                  line2: address.address_line_2 || '',
                  city: address.city,
                  postal_code: address.postal_code,
                  country: address.country || 'GN'  // Valeur par défaut pour la Guinée
                }
              }
            }
          }
        });

        if (error) {
          messageDiv.textContent = error.message || "Une erreur est survenue.";
          messageDiv.className = 'text-danger fw-bold';
        }
      } catch (err) {
        messageDiv.textContent = err.message;
        messageDiv.className = 'text-danger fw-bold';
      } finally {
        submitBtn.disabled = false;
        btnText.style.display = 'inline-block';
        btnLoading.style.display = 'none';
      }
    });
  {% else %}
    document.getElementById('payment-element').innerHTML = 
      '<p class="text-danger text-center py-4">Paiement temporairement indisponible. Veuillez réessayer plus tard.</p>';
    document.getElementById('submit-btn').disabled = true;
  {% endif %}
</script>
{% endblock %}





{% comment %} {% extends 'base.html' %}
{% load static %}{% block title %}Paiement Sécurisé - AgriBusiness{% endblock %}{% block extra_css %}<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
  /* En-tête principal */
  .checkout-header {
    text-align: center;
    padding: clamp(3rem, 8vw, 4rem) clamp(1.5rem, 5vw, 2rem) clamp(2.5rem, 6vw, 3rem);
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.08), rgba(46, 125, 50, 0.03));
    border-radius: 30px;
    margin-bottom: 3rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  }

  .checkout-title {
    font-size: clamp(2.2rem, 5vw, 3rem);
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 1rem;
  }  .checkout-subtitle {
    font-size: clamp(0.8rem, 2.5vw, 1rem);
    color: #4caf50;
    font-weight: 500;
    max-width: 700px;
    margin: 0 auto;
  }  .security-badges {
    margin-top: 2rem;
    opacity: 0.85;
    display: flex;
    justify-content: center;
    gap: clamp(1rem, 3vw, 1.5rem);
  }  .security-badges i {
    font-size: clamp(2rem, 5vw, 2.8rem);
    color: #4caf50;
  }  /* Cartes */
  .checkout-card {
    background: white;
    border-radius: 28px;
    padding: clamp(2rem, 5vw, 3rem);
    box-shadow: 0 12px 40px rgba(0,0,0,0.09);
  }  .section-title {
    font-size: clamp(1.6rem, 4vw, 2rem);
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 2rem;
    padding-bottom: 0.8rem;
    border-bottom: 4px solid #4caf50;
    display: inline-block;
  }  /* Formulaire */
  .form-label {
    font-weight: 600;
    color: #2e7d32;
    margin-bottom: 0.8rem;
    font-size: clamp(0.95rem, 2.5vw, 1.05rem);
  }  .form-control {
    border-radius: 14px;
    border: 2px solid #e0e0e0;
    padding: clamp(0.8rem, 2vw, 1rem) clamp(1.2rem, 3vw, 1.4rem);
    font-size: clamp(0.95rem, 2.5vw, 1.05rem);
    transition: all 0.3s ease;
    background: #f8fff8;
  }  .form-control:focus {
    border-color: #4caf50;
    box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.2);
    background: white;
  }  textarea.form-control {
    min-height: clamp(100px, 25vw, 130px);
    resize: vertical;
  }  /* Stripe Element */
  #payment-element {
    background: white;
    padding: clamp(1.2rem, 4vw, 1.8rem);
    border-radius: 16px;
    border: 2px solid #e0e0e0;
    min-height: 120px;
    margin: 2rem 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }  /* Messages */
  #payment-message {
    min-height: 1.5em;
    padding: 0.8rem 0;
    font-size: clamp(0.85rem, 2.5vw, 1rem);
  }  /* Bouton paiement */
  .btn-pay {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    font-weight: 800;
    font-size: clamp(1.2rem, 3vw, 1.4rem);
    padding: clamp(1rem, 3vw, 1.3rem) clamp(2rem, 5vw, 2.5rem);
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    transition: all 0.3s ease;
    width: 100%;
    border: none;
  }  .btn-pay:hover:not(:disabled) {
    transform: translateY(-6px);
    box-shadow: 0 20px 40px rgba(76, 175, 80, 0.5);
  }  .btn-pay:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }  /* Récapitulatif */
  .order-summary {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    border-radius: 28px;
    padding: clamp(2.5rem, 5vw, 3rem);
    box-shadow: 0 15px 45px rgba(76, 175, 80, 0.35);
    position: sticky;
    top: 120px;
    height: fit-content;
  }  .summary-title {
    font-size: clamp(1.5rem, 3.5vw, 2rem);
    font-weight: 700;
    margin-bottom: 2rem;
    text-align: center;
  }  .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px dashed rgba(255,255,255,0.4);
    font-size: clamp(1rem, 2.5vw, 1.1rem);
  }  .summary-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }  .summary-total {
    font-size: clamp(1.8rem, 4vw, 2rem);
    font-weight: 900;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 3px solid white;
  }  /* Responsive */
  @media
 (max-width: 992px) {
    .order-summary {
      position: static;
      margin-top: 3rem;
    }
    .checkout-title {
      font-size: 2.6rem;
    }
  }  @media
 (max-width: 576px) {
    .checkout-header {
      padding: 3rem 1rem;
    }
    .checkout-card {
      padding: 2rem;
    }
    .section-title {
      font-size: 1.8rem;
    }
    .btn-pay {
      font-size: 1.2rem;
      padding: 1.1rem;
    }
  }
</style>
{% endblock %}{% block content %}<div class="container my-5" data-aos="fade-up">
  <!-- En-tête -->
  <div class="checkout-header" data-aos="zoom-in" data-aos-delay="100">
    <h1 class="checkout-title">Finaliser votre commande</h1>
    <p class="checkout-subtitle">
      Paiement 100% sécurisé • Livraison rapide par nos producteurs locaux
    </p>
    <div class="security-badges">
      <i class="fas fa-lock" title="Paiement chiffré"></i>
      <i class="fas fa-shield-alt" title="Données protégées"></i>
      <i class="fas fa-truck" title="Livraison traçable"></i>
    </div>
  </div>

  <div class="row g-5">
    <!-- Formulaire adresse + paiement -->
    <div class="col-lg-8">
      <div class="checkout-card" data-aos="fade-right" data-aos-delay="200">
        <form method="post" id="payment-form" hx-post="{% url 'marketplace:checkout' %}" hx-target="#order-summary" hx-swap="innerHTML" hx-indicator="#submit-btn .btn-loading">
          {% csrf_token %}

      <!-- Adresse de livraison -->
      <h3 class="section-title">
        <i class="fas fa-home me-3"></i>Adresse de livraison
      </h3>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nom complet *</label>
          {{ form.full_name }}
          {% if form.full_name.errors %}
            <div class="text-danger small mt-1">{{ form.full_name.errors }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Téléphone *</label>
          {{ form.phone }}
          {% if form.phone.errors %}
            <div class="text-danger small mt-1">{{ form.phone.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-4">
        <label class="form-label">Adresse ligne 1 *</label>
        {{ form.address_line_1 }}
        {% if form.address_line_1.errors %}
          <div class="text-danger small mt-1">{{ form.address_line_1.errors }}</div>
        {% endif %}
      </div>

      <div class="mt-4">
        <label class="form-label">Complément d'adresse (appartement, étage...)</label>
        {{ form.address_line_2 }}
      </div>

      <div class="row g-3 mt-4">
        <div class="col-md-6">
          <label class="form-label">Ville *</label>
          {{ form.city }}
          {% if form.city.errors %}
            <div class="text-danger small mt-1">{{ form.city.errors }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Code postal *</label>
          {{ form.postal_code }}
          {% if form.postal_code.errors %}
            <div class="text-danger small mt-1">{{ form.postal_code.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-5">
        <label class="form-label">Notes pour le producteur (facultatif)</label>
        {{ form.notes }}
        <small class="text-muted d-block mt-2">
          Ex: "Laisser devant la porte", "Appeler avant livraison", "Accès par le petit portail vert", "Remettre au voisin si absent", etc.
        </small>
      </div>

      <!-- Paiement -->
      <h3 class="section-title mt-5">
        <i class="fas fa-credit-card me-3"></i>Paiement sécurisé par carte
      </h3>

      <div id="payment-element">
        <!-- Stripe injectera le formulaire ici -->
      </div>

      <div id="payment-message" class="fw-bold"></div>

      <button type="submit" class="btn btn-pay mt-4" id="submit-btn">
        <span class="btn-text">
          <i class="fas fa-lock me-3"></i>
          Payer {{ cart.get_total_amount|floatformat:2 }} fg
        </span>
        <span class="btn-loading" style="display:none;">
          <i class="fas fa-spinner fa-spin me-3"></i> Traitement en cours...
        </span>
      </button>
    </form>
  </div>
</div>

<!-- Récapitulatif commande -->
<div class="col-lg-4">
  <div class="order-summary" id="order-summary" data-aos="fade-left" data-aos-delay="300">
    <h3 class="summary-title">
      <i class="fas fa-receipt me-3"></i>Récapitulatif
    </h3>

    {% for item in cart.items.all %}
      <div class="summary-item">
        <span>{{ item.quantity }} * {{ item.product.name }}</span>
        <strong>{{ item.get_subtotal|floatformat:2 }} fg </strong>
      </div>
    {% endfor %}

    <div class="summary-item summary-total d-flex justify-content-between">
      <span>Total à payer</span>
      <span>{{ cart.get_total_amount|floatformat:2 }} fg </span>
    </div>
  </div>
</div>  </div></div>

<!-- Stripe + Gestion paiement -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  {% if client_secret %}
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements({
      clientSecret: '{{ client_secret }}'
    });
    const paymentElement = elements.create('payment', {
      layout: 'tabs'
    });
    paymentElement.mount('#payment-element');

    const form = document.getElementById('payment-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const messageDiv = document.getElementById('payment-message');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline-block';
      messageDiv.textContent = '';

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.origin + '{% url "marketplace:payment_success" %}',
        },
      });

      if (error) {
        messageDiv.textContent = error.message || "Une erreur est survenue.";
        messageDiv.className = 'text-danger fw-bold';
        submitBtn.disabled = false;
        btnText.style.display = 'inline-block';
        btnLoading.style.display = 'none';
      }
    });
  {% else %}
    document.getElementById('payment-element').innerHTML = 
      '<p class="text-danger text-center py-4">Paiement temporairement indisponible. Veuillez réessayer plus tard.</p>';
    document.getElementById('submit-btn').disabled = true;
  {% endif %}
</script>
{% endblock %}  {% endcomment %}






{% comment %} {% extends 'base.html' %}
{% load static %}{% block title %}Paiement Sécurisé - AgriBusiness{% endblock %}{% block extra_css %}<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
  /* En-tête principal */
  .checkout-header {
    text-align: center;
    padding: 4rem 2rem 3rem;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.08), rgba(46, 125, 50, 0.03));
    border-radius: 30px;
    margin-bottom: 3rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  }

  .checkout-title {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 1rem;
  }  .checkout-subtitle {
    font-size: clamp(0.7rem, 3vw, 1.2rem);
    color: #4caf50;
    font-weight: 500;
    max-width: 700px;
    margin: 0 auto;
  }  .security-badges {
    margin-top: 2rem;
    opacity: 0.85;
    display: flex;
    justify-content: center;
    gap: 1.5rem;
  }  .security-badges i {
    font-size: clamp(2rem, 4vw, 2.8rem);
    color: #4caf50;
  }  /* Cartes */
  .checkout-card {
    background: white;
    border-radius: 28px;
    padding: clamp(2rem, 5vw, 3rem);
    box-shadow: 0 12px 40px rgba(0,0,0,0.09);
  }  .section-title {
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 2rem;
    padding-bottom: 0.8rem;
    border-bottom: 4px solid #4caf50;
    display: inline-block;
  }  /* Formulaire */
  .form-label {
    font-weight: 600;
    color: #2e7d32;
    margin-bottom: 0.8rem;
    font-size: clamp(1rem, 2.5vw, 1.05rem);
  }  .form-control {
    border-radius: 14px;
    border: 2px solid #e0e0e0;
    padding: clamp(0.8rem, 2vw, 1rem) clamp(1.2rem, 3vw, 1.4rem);
    font-size: clamp(1rem, 2.5vw, 1.05rem);
    transition: all 0.3s ease;
    background: #f8fff8;
  }  .form-control:focus {
    border-color: #4caf50;
    box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.2);
    background: white;
  }  textarea.form-control {
    min-height: 130px;
    resize: vertical;
  }  /* Stripe Element */
  #payment-element {
    background: white;
    padding: clamp(1.5rem, 4vw, 1.8rem);
    border-radius: 16px;
    border: 2px solid #e0e0e0;
    min-height: 120px;
    margin: 2rem 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }  /* Messages */
  #payment-message {
    min-height: 1.5em;
    padding: 0.8rem 0;
    font-size: clamp(0.9rem, 2.5vw, 1rem);
  }  /* Bouton paiement */
  .btn-pay {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    font-weight: 800;
    font-size: clamp(1.2rem, 3vw, 1.4rem);
    padding: clamp(1.1rem, 3vw, 1.3rem) clamp(2rem, 5vw, 2.5rem);
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    transition: all 0.3s ease;
    width: 100%;
    border: none;
  }  .btn-pay:hover:not(:disabled) {
    transform: translateY(-6px);
    box-shadow: 0 20px 40px rgba(76, 175, 80, 0.5);
  }  .btn-pay:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }  /* Récapitulatif */
  .order-summary {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    border-radius: 28px;
    padding: 2.5rem 2vw 3rem 3vw;
    box-shadow: 0 15px 45px rgba(76, 175, 80, 0.35);
    position: sticky;
    top: 120px;
    height: fit-content;
  }  .summary-title {
    font-size: clamp(1.5rem, 3.5vw, 2rem);
    font-weight: 700;
    margin-bottom: 2rem;
    text-align: center;
  }  .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px dashed rgba(255,255,255,0.4);
    font-size: clamp(1rem, 2.5vw, 1.1rem);
  }  .summary-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }  .summary-total {
    font-size: clamp(1.8rem, 4vw, 2rem);
    font-weight: 900;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 3px solid white;
  }  /* Responsive */
  @media
 (max-width: 992px) {
    .order-summary {
      position: static;
      margin-top: 3rem;
    }
    .checkout-title {
      font-size: 2.6rem;
    }
  }  @media
 (max-width: 576px) {
    .checkout-header {
      padding: 3rem 1rem;
    }
    .checkout-card {
      padding: 2rem;
    }
    .section-title {
      font-size: 1.8rem;
    }
    .btn-pay {
      font-size: 1.2rem;
      padding: 1.1rem;
    }
  }
</style>
{% endblock %}{% block content %}<div class="container my-5" data-aos="fade-up">
  <!-- En-tête -->
  <div class="checkout-header" data-aos="zoom-in" data-aos-delay="100">
    <h1 class="checkout-title">Finaliser votre commande</h1>
    <p class="checkout-subtitle">
      Paiement 100% sécurisé • Livraison rapide par nos producteurs locaux
    </p>
    <div class="security-badges">
      <i class="fas fa-lock" title="Paiement chiffré"></i>
      <i class="fas fa-shield-alt" title="Données protégées"></i>
      <i class="fas fa-truck" title="Livraison traçable"></i>
    </div>
  </div>

  <div class="row g-5">
    <!-- Formulaire adresse + paiement -->
    <div class="col-lg-8">
      <div class="checkout-card" data-aos="fade-right" data-aos-delay="200">
        <form method="post" id="payment-form" hx-post="{% url 'marketplace:checkout' %}" hx-target="#order-summary" hx-swap="innerHTML" hx-indicator="#submit-btn .btn-loading">
          {% csrf_token %}

      <!-- Adresse de livraison -->
      <h3 class="section-title">
        <i class="fas fa-home me-3"></i>Adresse de livraison
      </h3>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nom complet *</label>
          {{ form.full_name }}
          {% if form.full_name.errors %}
            <div class="text-danger small mt-1">{{ form.full_name.errors }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Téléphone *</label>
          {{ form.phone }}
          {% if form.phone.errors %}
            <div class="text-danger small mt-1">{{ form.phone.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-4">
        <label class="form-label">Adresse ligne 1 *</label>
        {{ form.address_line_1 }}
        {% if form.address_line_1.errors %}
          <div class="text-danger small mt-1">{{ form.address_line_1.errors }}</div>
        {% endif %}
      </div>

      <div class="mt-4">
        <label class="form-label">Complément d'adresse (appartement, étage...)</label>
        {{ form.address_line_2 }}
      </div>

      <div class="row g-3 mt-4">
        <div class="col-md-6">
          <label class="form-label">Ville *</label>
          {{ form.city }}
          {% if form.city.errors %}
            <div class="text-danger small mt-1">{{ form.city.errors }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Code postal *</label>
          {{ form.postal_code }}
          {% if form.postal_code.errors %}
            <div class="text-danger small mt-1">{{ form.postal_code.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-5">
        <label class="form-label">Notes pour le producteur (facultatif)</label>
        {{ form.notes }}
        <small class="text-muted d-block mt-2">
          Ex: "Laisser devant la porte", "Appeler avant livraison", "Accès par le petit portail vert", "Remettre au voisin si absent", etc.
        </small>
      </div>

      <!-- Paiement -->
      <h3 class="section-title mt-5">
        <i class="fas fa-credit-card me-3"></i>Paiement sécurisé par carte
      </h3>

      <div id="payment-element">
        <!-- Stripe injectera le formulaire ici -->
      </div>

      <div id="payment-message" class="fw-bold"></div>

      <button type="submit" class="btn btn-pay mt-4" id="submit-btn">
        <span class="btn-text">
          <i class="fas fa-lock me-3"></i>
          Payer {{ cart.get_total_amount|floatformat:2 }} fg
        </span>
        <span class="btn-loading" style="display:none;">
          <i class="fas fa-spinner fa-spin me-3"></i> Traitement en cours...
        </span>
      </button>
    </form>
  </div>
</div>

<!-- Récapitulatif commande -->
<div class="col-lg-4">
  <div class="order-summary" id="order-summary" data-aos="fade-left" data-aos-delay="300">
    <h3 class="summary-title">
      <i class="fas fa-receipt me-3"></i>Récapitulatif
    </h3>

    {% for item in cart.items.all %}
      <div class="summary-item">
        <span>{{ item.quantity }} * {{ item.product.name }}</span>
        <strong>{{ item.get_subtotal|floatformat:2 }} fg </strong>
      </div>
    {% endfor %}

    <div class="summary-item summary-total d-flex justify-content-between">
      <span>Total à payer</span>
      <span>{{ cart.get_total_amount|floatformat:2 }} fg </span>
    </div>
  </div>
</div>  </div>
</div>

<!-- Stripe + Gestion paiement -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  {% if client_secret %}
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements({
      clientSecret: '{{ client_secret }}'
    });
    const paymentElement = elements.create('payment', {
      layout: 'tabs'
    });
    paymentElement.mount('#payment-element');

    const form = document.getElementById('payment-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const messageDiv = document.getElementById('payment-message');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline-block';
      messageDiv.textContent = '';

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.origin + '{% url "marketplace:payment_success" %}',
        },
      });

      if (error) {
        messageDiv.textContent = error.message || "Une erreur est survenue.";
        messageDiv.className = 'text-danger fw-bold';
        submitBtn.disabled = false;
        btnText.style.display = 'inline-block';
        btnLoading.style.display = 'none';
      }
    });
  {% else %}
    document.getElementById('payment-element').innerHTML = 
      '<p class="text-danger text-center py-4">Paiement temporairement indisponible. Veuillez réessayer plus tard.</p>';
    document.getElementById('submit-btn').disabled = true;
  {% endif %}
</script>
{% endblock %}




{% comment %} {% extends 'base.html' %}
{% load static %}

{% block title %}Paiement Sécurisé - AgriBusiness{% endblock %}

{% block extra_css %}
<style>
  /* En-tête principal */
  .checkout-header {
    text-align: center;
    padding: 4rem 2rem 3rem;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.08), rgba(46, 125, 50, 0.03));
    border-radius: 30px;
    margin-bottom: 3rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  }

  .checkout-title {
    font-size: 2rem;
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 1rem;
  }

  .checkout-subtitle {
    font-size: 0.7rem;
    color: #4caf50;
    font-weight: 500;
    max-width: 700px;
    margin: 0 auto;
  }

  .security-badges {
    margin-top: 2rem;
    opacity: 0.85;
  }

  .security-badges i {
    font-size: 2.8rem;
    margin: 0 1.2rem;
    color: #4caf50;
  }

  /* Cartes */
  .checkout-card {
    background: white;
    border-radius: 28px;
    padding: 3rem;
    box-shadow: 0 12px 40px rgba(0,0,0,0.09);
  }

  .section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 2rem;
    padding-bottom: 0.8rem;
    border-bottom: 4px solid #4caf50;
    display: inline-block;
  }

  /* Formulaire */
  .form-label {
    font-weight: 600;
    color: #2e7d32;
    margin-bottom: 0.8rem;
    font-size: 1.05rem;
  }

  .form-control {
    border-radius: 14px;
    border: 2px solid #e0e0e0;
    padding: 1rem 1.4rem;
    font-size: 1.05rem;
    transition: all 0.3s ease;
    background: #f8fff8;
  }

  .form-control:focus {
    border-color: #4caf50;
    box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.2);
    background: white;
  }

  textarea.form-control {
    min-height: 130px;
    resize: vertical;
  }

  /* Stripe Element */
  #payment-element {
    background: white;
    padding: 1.8rem;
    border-radius: 16px;
    border: 2px solid #e0e0e0;
    min-height: 120px;
    margin: 2rem 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  /* Messages */
  #payment-message {
    min-height: 1.5em;
    padding: 0.8rem 0;
  }

  /* Bouton paiement */
  .btn-pay {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    font-weight: 800;
    font-size: 1.4rem;
    padding: 1.3rem 2.5rem;
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    transition: all 0.3s ease;
    width: 100%;
    border: none;
  }

  .btn-pay:hover:not(:disabled) {
    transform: translateY(-6px);
    box-shadow: 0 20px 40px rgba(76, 175, 80, 0.5);
  }

  .btn-pay:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  /* Récapitulatif */
  .order-summary {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    border-radius: 28px;
    padding: 3rem;
    box-shadow: 0 15px 45px rgba(76, 175, 80, 0.35);
    position: sticky;
    top: 120px;
    height: fit-content;
  }

  .summary-title {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 2rem;
    text-align: center;
  }

  .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px dashed rgba(255,255,255,0.4);
    font-size: 1.1rem;
  }

  .summary-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .summary-total {
    font-size: 2rem;
    font-weight: 900;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 3px solid white;
  }

  /* Responsive */
  @media (max-width: 992px) {
    .order-summary {
      position: static;
      margin-top: 3rem;
    }
    .checkout-title {
      font-size: 2.6rem;
    }
  }

  @media (max-width: 576px) {
    .checkout-header {
      padding: 3rem 1rem;
    }
    .checkout-card {
      padding: 2rem;
    }
    .section-title {
      font-size: 1.8rem;
    }
    .btn-pay {
      font-size: 1.2rem;
      padding: 1.1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
  <!-- En-tête -->
  <div class="checkout-header">
    <h1 class="checkout-title">Finaliser votre commande</h1>
    <p class="checkout-subtitle">
      Paiement 100% sécurisé • Livraison rapide par nos producteurs locaux
    </p>
    <div class="security-badges">
      <i class="fas fa-lock" title="Paiement chiffré"></i>
      <i class="fas fa-shield-alt" title="Données protégées"></i>
      <i class="fas fa-truck" title="Livraison traçable"></i>
    </div>
  </div>

  <div class="row">
    <!-- Formulaire adresse + paiement -->
    <div class="col-lg-8">
      <div class="checkout-card">
        <form method="post" id="payment-form">
          {% csrf_token %}

          <!-- Adresse de livraison -->
          <h3 class="section-title">
            <i class="fas fa-home me-3"></i>Adresse de livraison
          </h3>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nom complet *</label>
              {{ form.full_name }}
              {% if form.full_name.errors %}
                <div class="text-danger small mt-1">{{ form.full_name.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label">Téléphone *</label>
              {{ form.phone }}
              {% if form.phone.errors %}
                <div class="text-danger small mt-1">{{ form.phone.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="mt-4">
            <label class="form-label">Adresse ligne 1 *</label>
            {{ form.address_line_1 }}
            {% if form.address_line_1.errors %}
              <div class="text-danger small mt-1">{{ form.address_line_1.errors }}</div>
            {% endif %}
          </div>

          <div class="mt-4">
            <label class="form-label">Complément d'adresse (appartement, étage...)</label>
            {{ form.address_line_2 }}
          </div>

          <div class="row g-3 mt-4">
            <div class="col-md-6">
              <label class="form-label">Ville *</label>
              {{ form.city }}
              {% if form.city.errors %}
                <div class="text-danger small mt-1">{{ form.city.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label">Code postal *</label>
              {{ form.postal_code }}
              {% if form.postal_code.errors %}
                <div class="text-danger small mt-1">{{ form.postal_code.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="mt-5">
            <label class="form-label">Notes pour le producteur (facultatif)</label>
            {{ form.notes }}
            <small class="text-muted d-block mt-2">
              Ex: "Laisser devant la porte", "Appeler avant livraison", "Accès par le petit portail vert", "Remettre au voisin si absent", etc.
            </small>
          </div>

          <!-- Paiement -->
          <h3 class="section-title mt-5">
            <i class="fas fa-credit-card me-3"></i>Paiement sécurisé par carte
          </h3>

          <div id="payment-element">
            <!-- Stripe injectera le formulaire ici -->
          </div>

          <div id="payment-message" class="fw-bold"></div>

          <button type="submit" class="btn btn-pay mt-4" id="submit-btn">
            <span class="btn-text">
              <i class="fas fa-lock me-3"></i>
              Payer {{ cart.get_total_amount|floatformat:2 }} €
            </span>
            <span class="btn-loading" style="display:none;">
              <i class="fas fa-spinner fa-spin me-3"></i> Traitement en cours...
            </span>
          </button>
        </form>
      </div>
    </div>

    <!-- Récapitulatif commande -->
    <div class="col-lg-4">
      <div class="order-summary">
        <h3 class="summary-title">
          <i class="fas fa-receipt me-3"></i>Récapitulatif
        </h3>

        {% for item in cart.items.all %}
          <div class="summary-item">
            <span>{{ item.quantity }} × {{ item.product.name }}</span>
            <strong>{{ item.get_subtotal|floatformat:2 }} €</strong>
          </div>
        {% endfor %}

        <div class="summary-item summary-total d-flex justify-content-between">
          <span>Total à payer</span>
          <span>{{ cart.get_total_amount|floatformat:2 }} €</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stripe + Gestion paiement -->
<script src="https://js.stripe.com/v3/"></script>
<script src="https://js.stripe.com/v3/"></script>
<script>
  {% if client_secret %}
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    const paymentElement = elements.create('payment', {
      layout: 'tabs'
    });
    paymentElement.mount('#payment-element');

    const form = document.getElementById('payment-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const messageDiv = document.getElementById('payment-message');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline-block';
      messageDiv.textContent = '';

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.origin + '{% url "marketplace:payment_success" %}',
        },
      });

      if (error) {
        messageDiv.textContent = error.message || "Une erreur est survenue.";
        messageDiv.className = 'text-danger fw-bold';
        submitBtn.disabled = false;
        btnText.style.display = 'inline-block';
        btnLoading.style.display = 'none';
      }
    });
  {% else %}
    // Si pas de client_secret (erreur montant ou Stripe)
    document.getElementById('payment-element').innerHTML = 
      '<p class="text-danger text-center">Paiement temporairement indisponible. Veuillez réessayer plus tard.</p>';
    document.getElementById('submit-btn').disabled = true;
  {% endif %}
</script>
{% endblock %} {% endcomment %} 
